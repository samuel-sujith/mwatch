apiVersion: v1
kind: Namespace
metadata:
  name: custom-metrics
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: custom-metrics:system:auth-delegator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:auth-delegator
subjects:
- kind: ServiceAccount
  name: custom-metrics-apiserver
  namespace: custom-metrics
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: custom-metrics-auth-reader
  namespace: kube-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: extension-apiserver-authentication-reader
subjects:
- kind: ServiceAccount
  name: custom-metrics-apiserver
  namespace: custom-metrics
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: custom-metrics-apiserver
  name: custom-metrics-apiserver
  namespace: custom-metrics
spec:
  replicas: 1
  selector:
    matchLabels:
      app: custom-metrics-apiserver
  template:
    metadata:
      labels:
        app: custom-metrics-apiserver
      name: custom-metrics-apiserver
    spec:
      serviceAccountName: custom-metrics-apiserver
      containers:
      - name: custom-metrics-apiserver
        image: samuelsujith/promadapter:20May2020
        imagePullPolicy: Always
        args:
        - --secure-port=6443
        - --logtostderr=true
        - --v=10
        env:
          - name: PROM_IP
            value: "http://10.0.94.244:8080/metrics"
        ports:
        - containerPort: 6443
          name: https
        - containerPort: 8080
          name: http
        volumeMounts:
        - mountPath: /var/run/serving-cert
          name: volume-serving-cert
          readOnly: true
        - mountPath: /tmp
          name: temp-vol
      volumes:
      - name: volume-serving-cert
        secret:
          secretName: cm-adapter-serving-certs  
      - name: temp-vol
        emptyDir: {}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: custom-metrics-resource-reader
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: custom-metrics-resource-reader
subjects:
- kind: ServiceAccount
  name: custom-metrics-apiserver
  namespace: custom-metrics
---
kind: ServiceAccount
apiVersion: v1
metadata:
  name: custom-metrics-apiserver
  namespace: custom-metrics
---
apiVersion: v1
kind: Service
metadata:
  name: custom-metrics-apiserver
  namespace: custom-metrics
spec:
  ports:
  - name: https
    port: 443
    targetPort: 6443
  - name: http
    port: 80
    targetPort: 8080
  selector:
    app: custom-metrics-apiserver
---
apiVersion: apiregistration.k8s.io/v1beta1
kind: APIService
metadata:
  name: v1beta1.custom.metrics.k8s.io
spec:
  service:
    name: custom-metrics-apiserver
    namespace: custom-metrics
  group: custom.metrics.k8s.io
  version: v1beta1
  insecureSkipTLSVerify: true
  groupPriorityMinimum: 100
  versionPriority: 100
---
apiVersion: apiregistration.k8s.io/v1beta1
kind: APIService
metadata:
  name: v1beta2.custom.metrics.k8s.io
spec:
  service:
    name: custom-metrics-apiserver
    namespace: custom-metrics
  group: custom.metrics.k8s.io
  version: v1beta2
  insecureSkipTLSVerify: true
  groupPriorityMinimum: 100
  versionPriority: 200
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: custom-metrics-server-resources
rules:
- apiGroups:
  - custom.metrics.k8s.io
  resources: ["*"]
  verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: custom-metrics-resource-reader
rules:
- apiGroups:
  - ""
  resources:
  - namespaces
  - pods
  - services
  verbs:
  - get
  - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: hpa-controller-custom-metrics
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: custom-metrics-server-resources
subjects:
- kind: ServiceAccount
  name: horizontal-pod-autoscaler
  namespace: kube-system
---
apiVersion: v1
kind: Secret
metadata:
  name: cm-adapter-serving-certs
  namespace: custom-metrics
data:
  serving.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURlVENDQW1HZ0F3SUJBZ0lVS2RtaW5vUDI5cVFWSVc1eTlacURBelRrR3Fnd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0RURUxNQWtHQTFVRUF3d0NZMkV3SGhjTk1qQXdOVEl3TVRrMU5EQXdXaGNOTWpVd05URTVNVGsxTkRBdwpXakFqTVNFd0h3WURWUVFERXhoamRYTjBiMjB0YldWMGNtbGpjeTFoY0dselpYSjJaWEl3Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUURuVWVVMmx3WC9KOUhkSHJ5aG0yTGRwODh1d2N6bFlqbUsKSVJUWWRkUk9NU3J2cmg1TDlKT2FTZFkxU1c5SUF2MUlsZHd4VDB6NGc3T3kxT0NDSWdrREcza2E3UHlGQ3ZKSgpuWmliUXVFTGhRSi95NkJoUEtpMGQ3a2R6aGYydzZpbDVOZGdVTGhzdFNiVW1YMkxWcTlhTy9BN21Db2FvYUZHClE3UUxTNzRhYnJBeDBrOVgwbmpKb3JOeThpaU8vK3VGaEU0OHIrZ29aaExDK2gzN2g2RHd6OEdoYlFuK0pyek8Kem1HeFhuZEtpaWhmdVRPY2JjK0ZqNHpPOStWNEh0MFVHRzY1MzRPVkp1SmFjVHdKODRoOWlVZ1JTRWs1SXhERwphRFErVTZVMTRNYnh0b3VrL3pBbW00c0R3d1RoMDBqbFcxTG84UCtaNmpGdmlwVTBIa2dMQWdNQkFBR2pnYm93CmdiY3dEZ1lEVlIwUEFRSC9CQVFEQWdXZ01Bd0dBMVVkRXdFQi93UUNNQUF3SFFZRFZSME9CQllFRkRxSzJ6MU8Kb1BrYVlRbkl5bWlDZWhDM2ZtdENNQjhHQTFVZEl3UVlNQmFBRkYzRUt6Z0NnRW05R0MxVjVNR1puNnVseGVGYgpNRmNHQTFVZEVRUlFNRTZDSTJOMWMzUnZiUzF0WlhSeWFXTnpMV0Z3YVhObGNuWmxjaTV0YjI1cGRHOXlhVzVuCmdpZGpkWE4wYjIwdGJXVjBjbWxqY3kxaGNHbHpaWEoyWlhJdWJXOXVhWFJ2Y21sdVp5NXpkbU13RFFZSktvWkkKaHZjTkFRRUxCUUFEZ2dFQkFDRWIxNjY5ZTRwZGpZRnlxR2pyeitGZzlZNDBxVXpzWDBOL3p0R3FzcGJhYi9SKwpLeHRCdkwvTlBIT256aWtiQlJzRW1neFdndkVIOTVDZTFDeExHa0dTUTBhMXhYakhwN1YxMlJsbTdqcU5PK1BJCnRUUzB2dTdESmZjOERtN2ZMaU9DbUF3VnRhajdjeW1XS1pLNWlnQitFUzRHc2xyTDNrM3M4dnI5ZEFKMmdJRlQKei9SSUJYSGhmajV0dUp5b2F1dUUxeE9iRGZUWWRQWEFlU0R4cGw2akowWU9DeUw0bitQVnIvZkFrSU1JUWt0ZApNNWQ1ZDM2Z0VuU0s5eDVSMytRcGxlcTlMNHh6Q0NnOE1iTXNmUTRzeWpNZ1ZDMEw5SjNOemxYTnc5Y2V1TGtRCmhGcXFOR1JNNk1FQTg0ZHgxWHg1NzdUdm9HRzdRWDFyTnloSFgyND0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  serving.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBNTFIbE5wY0YveWZSM1I2OG9adGkzYWZQTHNITTVXSTVpaUVVMkhYVVRqRXE3NjRlClMvU1Rta25XTlVsdlNBTDlTSlhjTVU5TStJT3pzdFRnZ2lJSkF4dDVHdXo4aFFyeVNaMlltMExoQzRVQ2Y4dWcKWVR5b3RIZTVIYzRYOXNPb3BlVFhZRkM0YkxVbTFKbDlpMWF2V2p2d081Z3FHcUdoUmtPMEMwdStHbTZ3TWRKUApWOUo0eWFLemN2SW9qdi9yaFlST1BLL29LR1lTd3ZvZCs0ZWc4TS9Cb1cwSi9pYTh6czVoc1Y1M1Nvb29YN2t6Cm5HM1BoWStNenZmbGVCN2RGQmh1dWQrRGxTYmlXbkU4Q2ZPSWZZbElFVWhKT1NNUXhtZzBQbE9sTmVERzhiYUwKcFA4d0pwdUxBOE1FNGROSTVWdFM2UEQvbWVveGI0cVZOQjVJQ3dJREFRQUJBb0lCQUFvRGRJMnhhZlFLc0Q0SApONWt6VmN0TW1WNW55MHZldmFqcUY3SHJIOTZtcURvcDZtdlZVWkpyUWRlYXJ6T0oxWmNQemJGZ3dtODduRXJRCmhrdDcxN0lIdlcxWjl2QjNjZGVYOStRNHQrODh1Y2Y0YzUvaDlWZWlteVBjS1JOb2t1TmpqYU5BdTBzUmFIWHAKa3hLMkZPOHVDdzg1WGhFN0QvVXZ0eHFLRTllbS8ranlVNXRBWjBvOEVEakI0engwa2RpZEFBVTdCb1NUREQzYgpLTW05SWNVUGNsQTgyYzBON0dlWW1SQjF1UjlWRG1BMGpqTzhkYkpUbS9kVjM3ajhrOHlFVUlNbHdmYWNyVVQrCjlMNWM3R0V5aWNXMHRrcExWNTR2dkNsamhwUVo0dHc1MXprY3ZVSm5zeHU4dkc4a3VSQzluLy92QkpxL1dMcHUKZ3pYcTVua0NnWUVBNlFJcFNKVUlDcGtQMWM3RkY3azZpTlRmVWtKaXdlcjhaTk0rRzR6eXZiK0hnS2J5YWtQZwpNWlF3WUQxajVieVVEMWh2eEpublI3OTVOM0Vsc2NrUW0vYXdXV1EwenlxaHhmTjc2YnRHbXllY041THFoSTVHCkJybU9pbjZDK3dhWDhXa2FaVVdVQzBnMUhBKzQ4aFJQYS9ldmhNdGFTQThRNmoxM0NLME1WRDhDZ1lFQS9pVVUKendoendUMWE5K3FNNWF2VUtETlNBQVIrY09hOExBRkxWaTRwQW1XWmhkdHNSZHhvNGVZbjZzeHQ3WmNtT0ZFYgpNaW9VVjdKNmVCekdkMGlGTkhrcW9UL09LRllSbm8xZzZCSVJITW42SnNLS2hwV1owanlOcHg4SzNyeGZOMWJxCnRIKzUraFZ5cU1GWE5id3M4bHpldU1UNXFGQktOZnNDdFFFOWFUVUNnWUVBcXJVb3BjSjV4N25udmc3a21zTGIKdlkrbnBVNTVwL1NPd1JkNmN4aktablhCd21HTlRJazU0VmplTUVRSndqQnNrT21MeVErd1FBSnB2bEtvK1IyRAppNkFxQnZQQk5OM1k4M3UxRnNKYnNpUk04UEl6MnJXWlhDZnA1RkZYaUsyRitCbTJldWVFMU5jc0Fja0xDR0FVCjU5Ym93bk54UzBXdWNNNWpQUG43QkdVQ2dZRUEvYWNBNThtbHpwNXdKclJndi9JSm83M2svOE44ZHk2emJMQTIKQXVPN1puc0ZDVWFCQUJFR1ZVQ2pZb042ekFGcDBoZVJMelkwYTNybEpQQ0RYUlp5YkhicWgxbnBadlRRVFJFSwpRVldXNHNicjlyZUFEdWROU1RuS241d3ArempEUjdabU5wU3NoOS9VT240TmpzSXJraElDOFNNWGtsZmdXWlFYCmxaU1JPR2tDZ1lCS2VRYjlmVGtBd3dCSUsrZ2s4TTJRVlYwemFrZ1V0d1FKV012YnhTR2xpNnFZejU1S01acFMKUTFwMEl0Z0NOTStvenduNHF6eE9QcXh1VW81Umd6RHU3T3c4WStnWGZQNXgxalhXSDEyVE5IR3NmQXZBZmdtRApIeU5ialYxNmFFdmlvZ0RtVzFsOW1CU1NGTUdPL1BRcXJnU2dhWkppWWdGZ0kyTXJNbWV3RkE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
